<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <meta charset="UTF-8">
    <title>Device Profile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
    <style>
        #profilesList {
            width: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            overflow-y: auto;
            max-height: 500px;
            /* 5줄 높이 */
            border: 1px solid #ccc;
            padding: 10px;
        }

        .profile-item {
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header>
        <h1>Device Profile</h1>
    </header>
    <div class="container">
        <a href="./../virtual">Virtual Device Creator</a> | <a href="./../events">Virtual Device send event</a><br>
        <a href="./../capability">Capability Creator</a> | <a href="./../capabilityPresentation">Capability
            Presentation</a><br>
        <a href="./../profile">Device Profile</a> | <a href="./../configuration">Device Configuration</a> | <a
            href="./../presentation">Device Presentation</a><br>
        <a href="./../edge">Edge drivers</a> | <a href="./../channels">Edge channels</a><br>
        </br>Reference link: <a href="https://developer.smartthings.com/docs/devices/device-profiles"
            target="_blank">Device Profile documents</a><br>
        <main>
            <form id="profileForm">
                <a href="https://account.smartthings.com/tokens" target="_blank">Create PAT</a>
                <label for="patToken">PAT Token:<input type="password" size=30 id="patToken" name="patToken" required
                        oninput="listProfiles()"><input type="checkbox" id="togglePassword"
                        onclick="togglePasswordVisibility()">Show<br></label>
                <button type="button" onclick="saveData()">Save</button>
                <button type="button" onclick="loadData()">Load</button>
                <button type="button" onclick="clearData()">Clear</button></br>
                This information is stored on your local PC, not on a server</br></br>

                <h3>My Profiles:</h3>
                <div id="profilesList"></div><br>

                <label for="profileId">Profile ID: <input type="text" id="profileId" name="profileId">
                    <button type="button" onclick="retrieveProfile()">Retrieve</button><br></label>
                <label for="profileBody">Profile Body (YAML or JSON):</label><br>
                <textarea id="profileBody" name="profileBody" rows="20" cols="50" required></textarea></br>
                <button type="button" onclick="createProfile()">Create</button>
                <button type="button" onclick="updateProfile()">Update</button>
                <button type="button" onclick="publishProfile()">Publish</button>
                <button type="button" onclick="deleteProfile()">Delete</button>
            </form>
            <h3>Result:</h3>
            <pre id="result"></pre>
            <script>
                function togglePasswordVisibility() {
                    var passwordField = document.getElementById('patToken');
                    var toggleCheckbox = document.getElementById('togglePassword');
                    if (toggleCheckbox.checked) {
                        passwordField.type = 'text';
                    } else {
                        passwordField.type = 'password';
                    }
                }
                function saveData() {
                    var patData = document.getElementById('patToken').value;
                    localStorage.setItem('patData', patData);
                    alert('Data saved!');
                }
                function loadData() {
                    var patData = localStorage.getItem('patData');
                    if (patData !== null) {
                        document.getElementById('patToken').value = patData;
                        listProfiles();
                    }
                }
                function clearData() {
                    localStorage.removeItem('patData');
                    document.getElementById('patToken').value = '';
                    alert('Data cleared!');
                }
                function isJsonString(str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                }
                function createProfile() {
                    const patToken = document.getElementById("patToken").value;
                    const profileBody = document.getElementById("profileBody").value;
                    let bodyData;
                    let contentType = 'application/json';
                    if (isJsonString(profileBody)) {
                        bodyData = JSON.stringify(JSON.parse(profileBody), null, 2);
                    } else {
                        try {
                            const yamlObject = jsyaml.load(profileBody);
                            bodyData = JSON.stringify(yamlObject, null, 2);
                        } catch (e) {
                            document.getElementById("result").textContent = `YAML parsing error: ${e}`;
                            return;
                        }
                    }
                    fetch(`https://api.smartthings.com/v1/deviceprofiles`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${patToken}`,
                            'Content-Type': contentType
                        },
                        body: bodyData
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                            listProfiles();
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                function updateProfile() {
                    const patToken = document.getElementById("patToken").value;
                    const profileId = document.getElementById("profileId").value;
                    const profileBody = document.getElementById("profileBody").value;
                    let bodyData;
                    let contentType = 'application/json';
                    if (isJsonString(profileBody)) {
                        bodyData = JSON.stringify(JSON.parse(profileBody), null, 2);
                    } else {
                        try {
                            const yamlObject = jsyaml.load(profileBody);
                            bodyData = JSON.stringify(yamlObject, null, 2);
                        } catch (e) {
                            document.getElementById("result").textContent = `YAML parsing error: ${e}`;
                            return;
                        }
                    }
                    fetch(`https://api.smartthings.com/v1/deviceprofiles/${profileId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${patToken}`,
                            'Content-Type': contentType
                        },
                        body: bodyData
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                            listProfiles();
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                function retrieveProfile() {
                    const patToken = document.getElementById("patToken").value;
                    const profileId = document.getElementById("profileId").value;
                    if (!profileId) {
                        document.getElementById("result").textContent = 'Please enter Profile ID.';
                        return;
                    }
                    fetch(`https://api.smartthings.com/v1/deviceprofiles/${profileId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${patToken}`
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                return response.json().then(data => {
                                    throw new Error(JSON.stringify(data));
                                });
                            }
                        })
                        .then(data => {
                            const jsonData = JSON.stringify(data, null, 2);
                            document.getElementById("profileBody").value = jsonData;
                            document.getElementById("result").textContent = 'Profile retrieved successfully';
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                function listProfiles() {
                    const patToken = document.getElementById("patToken").value;
                    if (!patToken) return;
                    fetch('https://api.smartthings.com/v1/deviceprofiles', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${patToken}`
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            const profilesList = document.getElementById("profilesList");
                            profilesList.innerHTML = '';
                            if (data && data.items) {
                                data.items.forEach(profile => {
                                    const itemDiv = document.createElement("div");
                                    itemDiv.className = "profile-item";
                                    itemDiv.textContent = `${profile.name}`;
                                    itemDiv.onclick = function () {
                                        document.getElementById("profileId").value = profile.id;
                                        retrieveProfile();
                                    };
                                    profilesList.appendChild(itemDiv);
                                });
                            }
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                function publishProfile() {
                    const patToken = document.getElementById("patToken").value;
                    const profileId = document.getElementById("profileId").value;
                    fetch(`https://api.smartthings.com/v1/deviceprofiles/${profileId}/status`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${patToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ "deviceProfileStatus": "PUBLISHED" })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("profileBody").value = JSON.stringify(data, null, 2);
                            document.getElementById("result").textContent = 'Profile published successfully';
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                function deleteProfile() {
                    const patToken = document.getElementById("patToken").value;
                    const profileId = document.getElementById("profileId").value;
                    fetch(`https://api.smartthings.com/v1/deviceprofiles/${profileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${patToken}`
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                document.getElementById("result").textContent = 'Profile deleted successfully';
                                document.getElementById("profileId").value = '';
                                document.getElementById("profileBody").value = '';
                                listProfiles();
                            } else {
                                return response.json().then(data => {
                                    throw new Error(JSON.stringify(data));
                                });
                            }
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }
                window.onload = function () {
                    loadData();
                }
            </script>
        </main>
    </div>
    <footer>
        <p>by Booung &copy; 2024 <a href="https://cafe.naver.com/dothesmartthings" target="_blank">SmartThings naver
                cafe</a></p>
    </footer>
</body>

</html>