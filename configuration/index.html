<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../style.css">
    <meta charset="UTF-8">
    <title>Device Configuration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
</head>

<body>
    <header>
        <h1>Device Configuration</h1>
    </header>
    <div class="container">
        <a href="./../virtual">Virtual Device Creator</a> | <a href="./../events">Virtual Device send event</a><br>
        <a href="./../capability">Capability Creator</a> | <a href="./../capabilityPresentation">Capability
            Presentation</a><br>
        <a href="./../profile">Device Profile</a> | <a href="./../configuration">Device Configuration</a> | <a
            href="./../presentation">Device Presentation</a><br>
        <a href="./../edge">Edge drivers</a> | <a href="./../channels">Edge channels</a><br>
        </br>Reference link: <a
            href="https://developer.smartthings.com/docs/devices/configurations-and-presentations/device-configurations"
            target="_blank">Device Configuration documents</a><br>
        <main>
            <form id="configurationForm">
                <a href="https://account.smartthings.com/tokens" target="_blank">Create PAT</a>
                <label for="patToken">PAT Token:<input type="password" size=30 id="patToken" name="patToken"
                        required><input type="checkbox" id="togglePassword"
                        onclick="togglePasswordVisibility()">Show<br></label>
                <button onclick="saveData()">Save</button>
                <button onclick="loadData()">Load</button>
                <button onclick="clearData()">Clear</button></br>
                This information is stored on your local PC, not on a server</br></br>

                <label for="presentationId">Presentation ID: <input type="text" id="presentationId"
                        name="presentationId" required></label>
                <label for="manufacturerName">Manufacturer Name(Optional): <input type="text" id="manufacturerName"
                        name="manufacturerName" required></label>
                <button type="button" onclick="getConfiguration()">Retrieve</button><br><br>
                <label for="configurationBody">Configuration Body (YAML or JSON):</label>
                <textarea id="configurationBody" name="configurationBody" rows="20" cols="50" required></textarea></br>
                <button type="button" onclick="createConfiguration()">Create</button>
            </form>
            <h3>Result:</h3>
            <pre id="result"></pre>
            <script>
                function togglePasswordVisibility() {
                    var passwordField = document.getElementById('patToken');
                    var toggleCheckbox = document.getElementById('togglePassword');
                    if (toggleCheckbox.checked) {
                        passwordField.type = 'text';
                    } else {
                        passwordField.type = 'password';
                    }
                }
                function saveData() {
                    var patData = document.getElementById('patToken').value;
                    localStorage.setItem('patData', patData);
                    alert('Data saved!');
                }
                function loadData() {
                    var patData = localStorage.getItem('patData');
                    if (patData !== null) {
                        document.getElementById('patToken').value = patData;
                    }
                }
                function clearData() {
                    localStorage.removeItem('patData');
                    document.getElementById('patToken').value = '';
                    alert('Data cleared!');
                }
                function isJsonString(str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                }
                function createConfiguration() {
                    const patToken = document.getElementById("patToken").value;
                    const configurationBody = document.getElementById("configurationBody").value;
                    let bodyData;
                    let contentType = 'application/json';
                    if (isJsonString(configurationBody)) {
                        bodyData = JSON.stringify(JSON.parse(configurationBody), null, 2);
                    } else {
                        try {
                            const yamlObject = jsyaml.load(configurationBody);
                            bodyData = JSON.stringify(yamlObject, null, 2);
                        } catch (e) {
                            document.getElementById("result").textContent = `YAML parsing error: ${e}`;
                            return;
                        }
                    }
                    fetch(`https://api.smartthings.com/v1/presentation/deviceconfig`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${patToken}`,
                            'Content-Type': contentType
                        },
                        body: bodyData
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `${error}`;
                        });
                }
                function getConfiguration() {
                    const patToken = document.getElementById("patToken").value;
                    const presentationId = document.getElementById("presentationId").value;
                    const manufacturerName = document.getElementById("manufacturerName").value;
                    if (!presentationId) {
                        document.getElementById("result").textContent = 'Please enter Presentation ID';
                        return;
                    }

                    let url = `https://api.smartthings.com/v1/presentation/deviceconfig?presentationId=${presentationId}`;
                    if (manufacturerName) {
                        url += `&manufacturerName=${manufacturerName}`;
                    }

                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${patToken}`
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                return response.json().then(data => {
                                    throw new Error(JSON.stringify(data));
                                });
                            }
                        })
                        .then(data => {
                            const jsonData = JSON.stringify(data, null, 2);
                            document.getElementById("configurationBody").value = jsonData;
                            document.getElementById("result").textContent = 'Configuration retrieved successfully';
                        })
                        .catch(error => {
                            document.getElementById("result").textContent = `Error: ${error}`;
                        });
                }

                window.onload = function () {
                    loadData();
                }
            </script>
        </main>
    </div>
    <footer>
        <p>by Booung &copy; 2024 <a href="https://cafe.naver.com/dothesmartthings" target="_blank">SmartThings naver
                cafe</a></p>
    </footer>
</body>

</html>